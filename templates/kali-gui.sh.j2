#!/usr/bin/env bash
set -euo pipefail

# systemd unit sets XDG_RUNTIME_DIR to /run/kali-gui
: "${XDG_RUNTIME_DIR:?XDG_RUNTIME_DIR is not set}"
export WAYLAND_DISPLAY="${WAYLAND_DISPLAY:-wayland-1}"

# Start sway (headless)
sway >/tmp/sway.log 2>&1 &
SWAY_PID=$!

# Wait for the wayland socket
for i in $(seq 1 200); do
  [ -S "${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}" ] && break
  sleep 0.1
done

# Start VNC (if installed/enabled in role)
wayvnc {{ kali_gui_bind_ip }} {{ kali_gui_vnc_port }} >/tmp/wayvnc.log 2>&1 &
VNC_PID=$!

{% if kali_install_novnc | bool %}
# Optional browser endpoint via noVNC (bind explicitly; no TLS)
"/usr/share/novnc/utils/novnc_proxy" \
  --listen {{ kali_gui_bind_ip }}:{{ kali_gui_novnc_port }} \
  --vnc 127.0.0.1:{{ kali_gui_vnc_port }} \
  >/tmp/novnc.log 2>&1 &
NOVNC_PID=$!
{% endif %}

wait "${SWAY_PID}"
